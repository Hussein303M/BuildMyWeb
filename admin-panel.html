<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - BuildMyWeb</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<header>
<h1>Admin Panel</h1>
</header>

<!-- GOD MODE SECTION -->
<section id="godmode" style="margin: 20px 0; padding: 10px; border: 2px solid #333; border-radius:5px; background:#f9f9f9;">
<h2 style="text-align:center;">God Mode</h2>
<label>God Mode Status: <span id="godStatus">Loading...</span></label><br><br>
<input id="masterKey" type="password" placeholder="Enter Master Key">
<button id="enableGod">Enable</button>
<button id="disableGod">Disable</button>
</section>

<section id="appointments">
<h2 style="text-align:center;">Appointments</h2>
<table>
<thead>
<tr>
<th>Slot</th>
<th>Name</th>
<th>Email</th>
<th>Business</th>
<th>Action</th>
</tr>
</thead>
<tbody id="appointments-body"></tbody>
</table>
</section>

<script>
// Redirect to login if not authenticated
if(sessionStorage.getItem("isAdmin") !== "true"){
    window.location.href = "admin.html";
}
</script>

<script>
const appointmentsBody = document.getElementById("appointments-body");

// Function to render all bookings
function renderBookings(){
    const bookings = JSON.parse(localStorage.getItem("bookings")) || [];
    appointmentsBody.innerHTML = "";

    bookings.forEach((b, index)=>{
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${b.slot}</td>
            <td>${b.name}</td>
            <td>${b.email}</td>
            <td>${b.business}</td>
            <td><button class="delete-btn" onclick="deleteBooking(${index})">Delete</button></td>
        `;
        appointmentsBody.appendChild(row);
    });
}

// Function to delete a booking
function deleteBooking(index){
    let bookings = JSON.parse(localStorage.getItem("bookings")) || [];
    let bookedSlots = JSON.parse(localStorage.getItem("bookedSlots")) || [];

    bookedSlots = bookedSlots.filter(slot => slot !== bookings[index].slot);
    localStorage.setItem("bookedSlots", JSON.stringify(bookedSlots));

    bookings.splice(index, 1);
    localStorage.setItem("bookings", JSON.stringify(bookings));

    renderBookings();
}

// Initial render
renderBookings();

// Refresh every 2 seconds to catch new bookings
setInterval(renderBookings, 2000);
</script>

<!-- GOD MODE JS -->
<script>
async function api(path, opts = {}) {
    const res = await fetch(path, Object.assign({credentials:'include', headers:{'Content-Type':'application/json'}}, opts));
    return res.json();
}

async function refreshGodMode() {
    const r = await api('/admin/settings');
    document.getElementById('godStatus').innerText = r.settings.godModeEnabled ? 'ENABLED' : 'OFF';
}

window.addEventListener('load', () => {
    refreshGodMode();

    document.getElementById('enableGod').addEventListener('click', async () => {
        const key = document.getElementById('masterKey').value;
        await api('/admin/godmode/toggle', { method:'POST', body: JSON.stringify({action:'enable', masterKey:key}) });
        refreshGodMode();
    });

    document.getElementById('disableGod').addEventListener('click', async () => {
        const key = document.getElementById('masterKey').value;
        await api('/admin/godmode/toggle', { method:'POST', body: JSON.stringify({action:'disable', masterKey:key}) });
        refreshGodMode();
    });
});
</script>

</body>
</html>
