<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - BuildMyWeb</title>
<link rel="stylesheet" href="style.css">
<style>
body {
    font-family: Arial, sans-serif;
    background: #121212;
    color: #fff;
    margin: 0;
    padding: 0;
}
header {
    background: #00bfff;
    color: #121212;
    padding: 15px;
    text-align: center;
}
.admin-summary {
    display: flex;
    justify-content: space-around;
    margin: 20px;
    background: #1e1e1e;
    padding: 15px;
    border-radius: 8px;
}
.admin-summary div {
    text-align: center;
}
.admin-actions {
    text-align: center;
    margin: 20px;
}
.admin-actions button {
    margin: 5px;
    padding: 10px 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
}
.add-btn { background-color: #00bfff; color: #121212; }
.edit-btn { background-color: #ffa500; color: #121212; }
.delete-btn { background-color: #ff4d4d; color: #fff; }
.delete-all-btn { background-color: #cc0000; color: #fff; }
.export-btn { background-color: #4caf50; color: #fff; }

.search-box {
    text-align: center;
    margin: 15px;
}
.search-box input {
    padding: 8px;
    width: 60%;
    border-radius: 6px;
    border: none;
}

table {
    width: 90%;
    margin: 20px auto;
    border-collapse: collapse;
    background: #1e1e1e;
}
table th, table td {
    padding: 12px;
    border: 1px solid #333;
    text-align: center;
}
</style>
</head>
<body>
<header>
    <h1>Admin Panel</h1>
</header>

<!-- Dashboard Summary -->
<section class="admin-summary">
    <div>
        <h2 id="weeklyCount">0</h2>
        <p>Bookings This Week</p>
    </div>
    <div>
        <h2 id="totalCount">0</h2>
        <p>Total Bookings</p>
    </div>
</section>

<!-- Admin Controls -->
<section class="admin-actions">
    <button class="add-btn" onclick="addBooking()">Add Booking</button>
    <button class="delete-all-btn" onclick="deleteAllBookings()">Delete All Bookings</button>
    <button class="export-btn" onclick="exportCSV()">Export CSV</button>
</section>

<!-- Search -->
<section class="search-box">
    <input type="text" id="searchInput" placeholder="Search bookings by name, email, or date..." onkeyup="renderBookings()">
</section>

<!-- Appointments Table -->
<section id="appointments">
    <h2 style="text-align:center;">Appointments</h2>
    <table>
        <thead>
            <tr>
                <th>Slot</th>
                <th>Name</th>
                <th>Email</th>
                <th>Business</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="appointments-body"></tbody>
    </table>
</section>

<!-- Contact Messages Section -->
<section id="messages">
    <h2 style="text-align:center;">Contact Messages</h2>
    <div class="admin-actions">
        <button class="delete-all-btn" onclick="deleteAllMessages()">Delete All Messages</button>
    </div>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Message</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="messages-body"></tbody>
    </table>
</section>

<script>
// Redirect to login if not authenticated
if (sessionStorage.getItem("isAdmin") !== "true") {
    window.location.href = "admin.html";
}

const appointmentsBody = document.getElementById("appointments-body");
const messagesBody = document.getElementById("messages-body");

// Render all bookings with search filter
function renderBookings() {
    const bookings = JSON.parse(localStorage.getItem("bookings")) || [];
    const search = document.getElementById("searchInput").value.toLowerCase();
    appointmentsBody.innerHTML = "";

    let weeklyCount = 0;
    const now = new Date();
    const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
    const weekEnd = new Date(now.setDate(weekStart.getDate() + 6));

    bookings.forEach((b, index) => {
        const match = 
            b.name.toLowerCase().includes(search) || 
            b.email.toLowerCase().includes(search) ||
            b.slot.toLowerCase().includes(search);

        if (!match) return;

        if (Date.parse(b.slot)) {
            const slotDate = new Date(b.slot);
            if (slotDate >= weekStart && slotDate <= weekEnd) weeklyCount++;
        }

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${b.slot}</td>
            <td>${b.name}</td>
            <td>${b.email}</td>
            <td>${b.business}</td>
            <td>
                <button class="edit-btn" onclick="editBooking(${index})">Edit</button>
                <button class="delete-btn" onclick="deleteBooking(${index})">Delete</button>
            </td>
        `;
        appointmentsBody.appendChild(row);
    });

    document.getElementById("weeklyCount").textContent = weeklyCount;
    document.getElementById("totalCount").textContent = bookings.length;
}

// Render messages
function renderMessages() {
    const messages = JSON.parse(localStorage.getItem("messages")) || [];
    messagesBody.innerHTML = "";

    messages.forEach((m, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${m.name}</td>
            <td>${m.email}</td>
            <td>${m.message}</td>
            <td>
                <button class="delete-btn" onclick="deleteMessage(${index})">Delete</button>
            </td>
        `;
        messagesBody.appendChild(row);
    });
}

// Add booking
function addBooking() {
    const slot = prompt("Enter slot (e.g. 2025-09-20 10:00 AM)");
    const name = prompt("Enter name");
    const email = prompt("Enter email");
    const business = prompt("Enter business");

    if (!slot || !name || !email || !business) return alert("All fields are required!");

    let bookings = JSON.parse(localStorage.getItem("bookings")) || [];
    bookings.push({ slot, name, email, business });
    localStorage.setItem("bookings", JSON.stringify(bookings));

    renderBookings();
}

// Edit booking
function editBooking(index) {
    let bookings = JSON.parse(localStorage.getItem("bookings")) || [];
    const booking = bookings[index];

    const newSlot = prompt("Edit slot", booking.slot);
    const newName = prompt("Edit name", booking.name);
    const newEmail = prompt("Edit email", booking.email);
    const newBusiness = prompt("Edit business", booking.business);

    bookings[index] = {
        slot: newSlot || booking.slot,
        name: newName || booking.name,
        email: newEmail || booking.email,
        business: newBusiness || booking.business,
    };

    localStorage.setItem("bookings", JSON.stringify(bookings));
    renderBookings();
}

// Delete single booking
function deleteBooking(index) {
    let bookings = JSON.parse(localStorage.getItem("bookings")) || [];
    bookings.splice(index, 1);
    localStorage.setItem("bookings", JSON.stringify(bookings));
    renderBookings();
}

// Delete all bookings
function deleteAllBookings() {
    if (confirm("Are you sure you want to delete ALL bookings?")) {
        localStorage.removeItem("bookings");
        localStorage.removeItem("bookedSlots");
        renderBookings();
    }
}

// Delete single message
function deleteMessage(index) {
    let messages = JSON.parse(localStorage.getItem("messages")) || [];
    messages.splice(index, 1);
    localStorage.setItem("messages", JSON.stringify(messages));
    renderMessages();
}

// Delete all messages
function deleteAllMessages() {
    if (confirm("Are you sure you want to delete ALL messages?")) {
        localStorage.removeItem("messages");
        renderMessages();
    }
}

// Export bookings as CSV
function exportCSV() {
    const bookings = JSON.parse(localStorage.getItem("bookings")) || [];
    if (bookings.length === 0) return alert("No bookings to export!");

    let csv = "Slot,Name,Email,Business\n";
    bookings.forEach(b => {
        csv += `"${b.slot}","${b.name}","${b.email}","${b.business}"\n`;
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "bookings.csv";
    a.click();
    URL.revokeObjectURL(url);
}

// Initial render
renderBookings();
renderMessages();

// Auto-refresh every 2s
setInterval(() => {
    renderBookings();
    renderMessages();
}, 2000);
</script>
</body>
</html>
